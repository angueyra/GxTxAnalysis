classdef iASubObj < handle
    properties
        % analysis restrictions
        istart
        iend
        index
        nbins
        % sorted first latencies
        flat
        flatp
        % open dwell times histogram and fit
        odt
        omin
        omax
        ohx
        ohy
        osx
        osy
        ofx
        ocoeffs
        ofit
        % closed dwell times histogram and fit
        cdt
        cmin
        cmax
        chx
        chy
        csx
        csy
        cfx
        ccoeffs
        cfit
    end
    
    properties (SetAccess = private)
    end
    
    methods
        function iASO=iASubObj()
        end
        
        function iASO=IAOunmixflats(iASO)
            iASO.flat=sort(iASO.flat(~isnan(iASO.flat)));
            iASO.flatp=(0:1/length(iASO.flat):1-1/length(iASO.flat))';
        end
        function iASO=IAOologhist(iASO)
            if isempty(iASO.odt)
                error('No open dwell time array provided\n')
            end
            logodt=log10(iASO.odt);
            logbins=linspace(iASO.omin,iASO.omax,iASO.nbins);
            d=diff(logbins)/2;
            iASO.ohx= [logbins(1:end-1)+d, logbins(end)]';               
            iASO.ohy=sqrt(histc(logodt,logbins));                      
            [iASO.osx,iASO.osy]=stairs(logbins,iASO.ohy);
        end
        
        function iASO=IAOcloghist(iASO)
            if isempty(iASO.cdt)
                error('No closed dwell time array provided\n')
            end
            logcdt=log10(iASO.cdt);
            logbins=linspace(iASO.cmin,iASO.cmax,iASO.nbins);
            d=diff(logbins)/2;
            iASO.chx= [logbins(1:end-1)+d, logbins(end)]';               
            iASO.chy=sqrt(histc(logcdt,logbins));                      
            [iASO.csx,iASO.csy]=stairs(logbins,iASO.chy);
        end
        
        function iASO=IAOohistfit(iASO,varargin)
            if nargin==2
                oguess=varargin{1};
            end
            if isempty(oguess)
                oguess=[20 log10(10)];
            end
            logexp=@(q,x)(q(1)^2 .* exp(  (1-( 10.^x ./ 10^q(2) ))) ./ (10^q(2)));
            logbinexp=@(q,x)sqrt( (10.^x) .* (  logexp(q,x)  ) );
            
            iASO.ocoeffs=nlinfit(iASO.ohx,iASO.ohy,logbinexp,oguess);
            iASO.ofit=logbinexp(iASO.ocoeffs,iASO.ohx);
            fprintf('_________________________________________\n')
            fprintf('Fit of open dwell times:\n')
            fprintf('\ttau = %g ms\n\talpha = %g\n',round(10^(iASO.ocoeffs(2))*1000)/1000,round((iASO.ocoeffs(1))*1000)/1000)
            fprintf('-----------------------------------------\n')
        end
        
        function iASO=IAOchistfit(iASO,varargin)
            if nargin==2
                cguess=varargin{1};
            end
            if isempty(cguess)
                cguess=[20 log10(10)];
            end
            logexp=@(q,x)(q(1)^2 .* exp(  (1-( 10.^x ./ 10^q(2) ))) ./ (10^q(2)));
            dblogbinexp=@(q,x)sqrt( (10.^x) .* (  logexp([q(1) q(2)],x) + logexp([q(3) q(4)],x)  ) );
            
            iASO.ocoeffs=nlinfit(iASO.ohx,iASO.ohy,logbinexp,oguess);
            iASO.ofit=logbinexp(iASO.ocoeffs,iASO.ohx);
            fprintf('_________________________________________\n')
            fprintf('Fit of open dwell times:\n')
            fprintf('\ttau = %g ms\n\talpha = %g\n',round(10^(iASO.ocoeffs(2))*1000)/1000,round((iASO.ocoeffs(1))*1000)/1000)
            fprintf('-----------------------------------------\n')
            
            
            
            g=[10 -0.1 4 0.9];
            gy_log=dblogbinexp(g,chx_log);
            
            cfc_log=nlinfit(chx_log,chy_log,dblogbinexp,g);
            fy_log=dblogbinexp(cfc_log,chx_log);
            fprintf('_________________________________________\n')
            fprintf('Fit of closed dwell times:\n')
            fprintf('   First exponential\tSecond exponential\n')
            fprintf('     tau1 = %g ms\t   tau2 = %g ms\n',round(10^(cfc_log(2))*1000)/1000,round(10^(cfc_log(4))*1000)/1000)
            fprintf('     alpha1 = %g\t   alpha2 = %g ms\n\n',round((cfc_log(1))*1000)/1000,round((cfc_log(3))*1000)/1000)
            fprintf('-----------------------------------------\n')
        end
    end
    
    methods (Static=true)
        function logbinexp=logbinexpfx()
            
        end
    end
end